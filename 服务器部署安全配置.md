# 服务器部署安全配置指南

## Agora SDK Web安全限制错误解决方案

### 错误描述
`AgoraRTCError WEB_SECURITY_RESTRICT` - 上下文受到Web安全限制，建议使用HTTPS协议或localhost

### 解决方案

#### 1. 启用HTTPS（推荐）

**方案A：使用Let's Encrypt免费SSL证书**

```bash
# 安装certbot
sudo apt update
sudo apt install certbot python3-certbot-nginx

# 申请SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加以下行：
0 12 * * * /usr/bin/certbot renew --quiet
```

**方案B：宝塔面板SSL配置**

1. 登录宝塔面板
2. 进入网站设置
3. 点击「SSL」选项卡
4. 选择「Let's Encrypt」
5. 填写域名并申请证书
6. 开启「强制HTTPS」

#### 2. Nginx HTTPS配置

创建或更新 `nginx-https.conf`：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL证书配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    
    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 安全头配置
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
    
    root /www/wwwroot/ai-resume/dist;
    index index.html;
    
    # Vue Router 历史模式支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

#### 3. 应用代码修改

如果项目中确实使用了需要安全上下文的功能，需要添加协议检测：

```javascript
// 在 main.js 或相关组件中添加
if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
  console.warn('当前非安全上下文，某些功能可能受限');
  // 可以显示提示信息给用户
}

// 检测是否支持安全上下文
if (!window.isSecureContext) {
  console.error('需要安全上下文（HTTPS或localhost）');
  // 显示错误提示或重定向到HTTPS
}
```

#### 4. 部署脚本更新

更新 `deploy-https.sh`：

```bash
#!/bin/bash

# HTTPS部署脚本

set -e

echo "🔒 开始HTTPS部署..."

# 检查SSL证书
if [ ! -f "/etc/letsencrypt/live/your-domain.com/fullchain.pem" ]; then
    echo "⚠️  SSL证书不存在，请先申请证书"
    echo "运行: sudo certbot --nginx -d your-domain.com"
    exit 1
fi

# 构建项目
echo "🔨 构建项目..."
npm run build

# 更新Nginx配置
echo "⚙️  更新Nginx配置..."
sudo cp nginx-https.conf /etc/nginx/sites-available/ai-resume
sudo ln -sf /etc/nginx/sites-available/ai-resume /etc/nginx/sites-enabled/

# 测试Nginx配置
sudo nginx -t

# 重启Nginx
sudo systemctl reload nginx

echo "✅ HTTPS部署完成！"
echo "🌐 访问: https://your-domain.com"
```

#### 5. 开发环境配置

对于本地开发，可以使用自签名证书：

```bash
# 生成自签名证书
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# 更新vite.config.js
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import fs from 'fs'

export default defineConfig({
  plugins: [vue()],
  server: {
    https: {
      key: fs.readFileSync('key.pem'),
      cert: fs.readFileSync('cert.pem'),
    },
    host: '0.0.0.0',
    port: 3000
  }
})
```

### 验证步骤

1. **检查HTTPS状态**
   ```bash
   curl -I https://your-domain.com
   ```

2. **验证SSL证书**
   ```bash
   openssl s_client -connect your-domain.com:443 -servername your-domain.com
   ```

3. **测试安全头**
   ```bash
   curl -I https://your-domain.com | grep -E "Strict-Transport-Security|X-Frame-Options"
   ```

### 常见问题

**Q: 证书申请失败**
A: 确保域名已正确解析到服务器IP，防火墙开放80和443端口

**Q: 混合内容错误**
A: 确保所有资源（CSS、JS、图片）都使用HTTPS或相对路径

**Q: 重定向循环**
A: 检查Nginx配置中的重定向规则，避免重复重定向

### 监控和维护

1. **SSL证书监控**
   ```bash
   # 检查证书到期时间
   echo | openssl s_client -servername your-domain.com -connect your-domain.com:443 2>/dev/null | openssl x509 -noout -dates
   ```

2. **自动化监控脚本**
   ```bash
   #!/bin/bash
   # ssl-monitor.sh
   DOMAIN="your-domain.com"
   DAYS_BEFORE_EXPIRY=30
   
   EXPIRY_DATE=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
   EXPIRY_TIMESTAMP=$(date -d "$EXPIRY_DATE" +%s)
   CURRENT_TIMESTAMP=$(date +%s)
   DAYS_UNTIL_EXPIRY=$(( ($EXPIRY_TIMESTAMP - $CURRENT_TIMESTAMP) / 86400 ))
   
   if [ $DAYS_UNTIL_EXPIRY -lt $DAYS_BEFORE_EXPIRY ]; then
       echo "⚠️  SSL证书将在 $DAYS_UNTIL_EXPIRY 天后过期！"
       # 发送通知或自动续期
   fi
   ```

---

按照以上配置，可以彻底解决Web安全限制错误，确保应用在生产环境中正常运行。